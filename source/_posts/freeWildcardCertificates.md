---
title: å…è´¹è·å–Let's Encryptæ³›åŸŸåè¯ä¹¦
date: 2020-07-30 19:10:21
tags: website
categories: ç½‘ç«™å»ºè®¾
photos: /img/banner/images/7.jpg
description: ä¸ºç½‘ç«™ä½¿ç”¨æ³›åŸŸåè¯ä¹¦
---

å»å¹´åœ¨`GoDaddy`ä¹°çš„`jeasonlau.xyz`åŸŸåå³å°†åˆ°æœŸï¼Œç„¶è€Œæœ€è¿‘å›Šä¸­ç¾æ¶©ç»­è´¹ä¸èµ·äº†ï¼Œäºæ˜¯è€ƒè™‘å°†ç½‘ç«™ä¸šåŠ¡è¿ç§»åˆ°`allwens.work`åŸŸåä¸‹ã€‚

ç›®å‰åœ¨`jeasonlau.xyz`åŸŸåä¸‹çš„æœåŠ¡ä¸»è¦æœ‰æˆ‘çš„é©¬åŸæ¯›æ¦‚åˆ·é¢˜å·¥å…·ã€ç”¨äºè®¢é˜…`RSS`çš„`RSSHub`å’Œä¸ªäººä½¿ç”¨çš„`Cloudreve`ç½‘ç›˜ï¼Œè¿ç§»çš„è¯æˆ‘æ‰“ç®—å°†å…¶æŒ‚åœ¨ä¸åŒçš„å­åŸŸåä¸‹ï¼Œæ‰€ä»¥æ‰“ç®—çœ‹çœ‹èƒ½ä¸èƒ½å…è´¹ç”³è¯·ä¸€å¼ æ³›åŸŸåè¯ä¹¦ï¼Œç»“æœè¿˜çœŸæ‰¾åˆ°äº†æ•™ç¨‹ã€‚

æŒ‰ç€æ•™ç¨‹èµ°äº†ä¸€éï¼Œæ•´ä¸ªæµç¨‹ä¸è¿‡ååˆ†é’Ÿï¼Œéå¸¸æ–¹ä¾¿ï¼Œæœ¬æ–‡ä¸»è¦è®°å½•ä¸€ä¸‹ç”³è¯·è¿‡ç¨‹ã€‚ğŸ˜†

<!-- more -->

## å®‰è£…`acme.sh`

`Let's Encrypt`å®˜æ–¹æä¾›äº†ä¸€ç³»åˆ—çš„ç”³è¯·æ–¹æ³•æ–‡æ¡£ï¼Œä½†æµç¨‹æ¯”è¾ƒå¤æ‚ã€‚æˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·`acme.sh`æ¥ç®€åŒ–ç”³è¯·æµç¨‹ã€‚

é¦–å…ˆå®‰è£…`acme.sh`ï¼š

```bash
curl  https://get.acme.sh | sh
```

è¯¥è„šæœ¬è¿›è¡Œçš„æ“ä½œæœ‰ï¼š

+ å°†`acme.sh`å®‰è£…åˆ°`~/.acme.sh/`ï¼›
+ `alias acme.sh = ~/.acme.sh/acme.sh`ï¼Œè¾¾åˆ°ç±»ä¼¼å®‰è£…åˆ°ç¯å¢ƒå˜é‡ä¸­çš„æ•ˆæœï¼›
+ è‡ªåŠ¨åˆ›å»º`cronjob`è„šæœ¬ï¼Œæ¯å¤©è‡ªåŠ¨æ£€æµ‹è¯ä¹¦ï¼Œå¦‚æœå¿«è¿‡æœŸåˆ™è‡ªåŠ¨æ›´æ–°ã€‚

## ä½¿ç”¨`DNS-API`éªŒè¯è·å–è¯ä¹¦

å‚è€ƒ[acme.shæ–‡æ¡£](https://github.com/acmesh-official/acme.sh/wiki/How-to-issue-a-cert)å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¾ˆå¤šç§æ–¹å¼è¿›è¡ŒåŸŸåéªŒè¯æ¥å¾—åˆ°è¯ä¹¦ã€‚å› ä¸ºæˆ‘çš„æœåŠ¡å™¨æœªå¤‡æ¡ˆï¼Œæ‰€ä»¥`web`çš„é‚£å‡ ç§æ–¹å¼ç”¨èµ·æ¥éƒ½ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œæœ€ç»ˆæˆ‘é€‰ç”¨äº†`DNS-API`æ¥è¿›è¡ŒéªŒè¯ã€‚

`DNS`éªŒè¯æŒ‡çš„æ˜¯é€šè¿‡åœ¨ä½ åŸŸåçš„DNSè§£æä¸­åŠ å…¥æŒ‡å®šçš„`txt`è®°å½•æ¥éªŒè¯ä½ å¯¹åŸŸåçš„æ‰€æœ‰æƒï¼Œè€Œ`DNS-API`åˆ™æ˜¯é€šè¿‡ä½¿ç”¨DNSæä¾›å•†çš„APIè‡ªåŠ¨è¿›è¡Œ`txt`è®°å½•çš„å¢åŠ å’Œåˆ é™¤ï¼Œè¾¾åˆ°è‡ªåŠ¨éªŒè¯çš„æ•ˆæœã€‚

å¯¹äºä¸åŒçš„æä¾›å•†ï¼Œéœ€è¦ä¸åŒçš„`API key`ï¼Œå¯ä»¥[ç‚¹å‡»æ­¤å¤„](https://github.com/acmesh-official/acme.sh/wiki/dnsapi)æŸ¥çœ‹è¯¦ç»†æ•™ç¨‹ï¼Œæ­¤å¤„ä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ã€‚

1. é¦–å…ˆåœ¨[é˜¿é‡Œäº‘è´¦å·çš„APIç®¡ç†](https://ak-console.aliyun.com/#/accesskey)ä¸­è·å–åˆ°`AccessKey ID`å’Œ`AccessKey Secret`

2. åœ¨æœåŠ¡å™¨ä¸­æ‰§è¡Œ

   ```bash
   export Ali_Key=AccessKey ID
   export Ali_Secret=AccessKey Secret
   ```

3. è¿è¡Œä»¥ä¸‹å‘½ä»¤è·å–è¯ä¹¦ï¼ˆä»¥`allwens.work`ä¸ºä¾‹ï¼‰

   ```bash
   acme.sh --issue --dns dns_ali -d allwens.work -d *.allwens.work
   ```

   å®Œæˆåï¼Œè¯ä¹¦æ–‡ä»¶å°†ä¼šå­˜æ”¾åœ¨`ï½/.acme.sh/allwens.work`ä¸­ï¼Œåç»­`acme.sh`å°†ä¼šè‡ªåŠ¨æ›´æ–°è¯¥æ–‡ä»¶å¤¹å†…çš„è¯ä¹¦ã€‚

   æˆ‘ç›®å‰å°šä¸æ¸…æ¥šæ›´æ–°æ—¶æ˜¯å¦éœ€è¦APIï¼Œå› æ­¤ä¸ºäº†ä¿é™©åˆå°†ç¬¬äºŒæ­¥åˆ›å»ºç¯å¢ƒå˜é‡çš„è¯­å¥å†™åˆ°äº†`~/.zshrc`ä¸­ã€‚

## åœ¨webæœåŠ¡å™¨ä¸­ä½¿ç”¨è¯ä¹¦

å› ä¸ºå«ŒåŸæœ‰çš„è·¯å¾„åè¿‡é•¿ï¼Œæ‰€ä»¥æˆ‘é¦–å…ˆåœ¨`/etc`ä¸‹æ–°å»ºäº†`cert`æ–‡ä»¶å¤¹ï¼Œåšäº†ä¸€ä¸ªè½¯é“¾æ¥ï¼š

> è¯¥æ­¥éª¤å¯ä»¥è·³è¿‡ï¼Œæˆ‘åªæ˜¯ä¸ºäº†è®©è·¯å¾„çŸ­ä¸€ç‚¹ ğŸ¤£

```bash
sudo mkdir /etc/cert
cd /etc/cert
ln -s ~/.acme.sh/allwens.work/allwens.work.cer ./
ln -s ~/.acme.sh/allwens.work/allwens.work.key ./
```

æ¥ç€æ‰“å¼€webæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ï¼ˆä»¥`nginx`ä¸ºä¾‹ï¼‰ï¼Œæ‰¾åˆ°éœ€è¦ä½¿ç”¨è¯ä¹¦çš„`Server`å—ï¼š

```nginx
# Cloudreve
server {
        server_name drive.allwens.work;
        location / {
                proxy_pass http://localhost:5212;
        }
        client_max_body_size 30g;
        error_page 497 =301 https://$http_host$request_uri;
        listen 10000;
        # åŠ å…¥å¦‚ä¸‹å†…å®¹
        ssl on;
        ssl_certificate /etc/cert/allwens.work.cer;
        ssl_certificate_key /etc/cert/allwens.work.key;
```

æ¥ç€è®©`nginx`é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶å³å¯ï¼š

```bash
nginx -s reload
```



